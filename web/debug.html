<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orus WebAssembly Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .log { background: #2d2d30; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { color: #f14c4c; }
        .success { color: #4caf50; }
        .info { color: #9cdcfe; }
        button { background: #0e639c; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #3c3c3c; cursor: not-allowed; }
        textarea { width: 100%; height: 200px; background: #1e1e1e; color: #d4d4d4; border: 1px solid #3e3e42; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Orus WebAssembly Debug</h1>
    
    <div class="log info">Loading WebAssembly module...</div>
    
    <div id="status" class="log">Status: Initializing...</div>
    
    <h3>Test Code:</h3>
    <textarea id="code">print("Hello, Orus WebAssembly!")
let x = 42
print("x =", x)</textarea>
    
    <div>
        <button id="testBtn" onclick="testWasm()" disabled>Test WASM</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <h3>Debug Output:</h3>
    <div id="output" class="log"></div>
    
    <script>
        let orusModule = null;
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            
            console.log(logEntry);
            updateOutput();
        }
        
        function updateOutput() {
            const output = document.getElementById('output');
            output.innerHTML = logs.map(entry => 
                `<div class="${entry.type}">${entry.message}</div>`
            ).join('');
        }
        
        function clearLogs() {
            logs = [];
            updateOutput();
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = `Status: ${message}`;
            status.className = `log ${type}`;
        }
        
        function testWasm() {
            if (!orusModule) {
                log('Error: WASM module not loaded', 'error');
                return;
            }
            
            const code = document.getElementById('code').value;
            log('Testing WASM with code: ' + code);
            
            try {
                // Set up output capture
                orusModule.Orus.onOutput(function(text) {
                    log('Orus Output: ' + text, 'success');
                });
                
                // Run the code
                const result = orusModule.Orus.run(code);
                log('Execution result: ' + result, result === 0 ? 'success' : 'error');
                
                // Get VM stats
                const stats = orusModule.Orus.getStats();
                log('VM Stats: ' + JSON.stringify(stats));
                
            } catch (error) {
                log('Error: ' + error.message, 'error');
                
                // Try to get more details
                try {
                    const lastError = orusModule.Orus.getLastError();
                    if (lastError) {
                        log('Last Error: ' + lastError, 'error');
                    }
                } catch (e) {
                    log('Failed to get last error: ' + e.message, 'error');
                }
            }
        }
        
        // Load the WASM module
        log('Starting WASM module load...');
        
        // Debug function for when module is ready
        function onModuleReady(Module) {
            orusModule = Module;
            log('WASM module loaded successfully', 'success');
            
            // Test basic API
            try {
                log('Testing version: ' + Module.Orus.version(), 'info');
                log('Testing VM ready: ' + Module.Orus.getStats().isReady, 'info');
                
                updateStatus('Ready', 'success');
                document.getElementById('testBtn').disabled = false;
                
            } catch (error) {
                log('Error testing API: ' + error.message, 'error');
                updateStatus('API Error', 'error');
            }
        }
        
        // Try to load the module
        try {
            // Load the script first
            const script = document.createElement('script');
            script.src = 'orus-web.js';
            script.onload = function() {
                log('orus-web.js loaded');
                
                // Try to instantiate the module
                if (typeof OrusModule !== 'undefined') {
                    log('OrusModule found, instantiating...');
                    OrusModule().then(function(Module) {
                        Module.onOrusReady = function() {
                            onModuleReady(Module);
                        };
                    }).catch(function(error) {
                        log('Failed to instantiate module: ' + error.message, 'error');
                        updateStatus('Load Failed', 'error');
                    });
                } else {
                    log('OrusModule not found after script load', 'error');
                    updateStatus('Module Not Found', 'error');
                }
            };
            script.onerror = function() {
                log('Failed to load orus-web.js', 'error');
                updateStatus('Script Load Failed', 'error');
            };
            document.head.appendChild(script);
            
        } catch (error) {
            log('Failed to load WASM: ' + error.message, 'error');
            updateStatus('Load Error', 'error');
        }
        
        log('Debug page initialized');
    </script>
</body>
</html>